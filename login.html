<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel Sensus Penduduk Purbalingga 2025</title>

<!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    .card {
      background-color: #fff;
      border-radius: 1rem;
      border: 1px solid #e2e8f0;
      padding: 1rem;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1e293b;
    }
    .kpi {
      background-color: #fff;
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    .kpi-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
    }
    .kpi-value {
      font-size: 2rem;
      font-weight: bold;
      margin-top: 0.25rem;
    }
    .kpi-sub {
      font-size: 0.75rem;
      color: #64748b;
    }
    .label {
      font-size: 0.75rem;
      font-weight: 500;
      color: #475569;
    }
    .input {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid #cbd5e1;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      outline: none;
    }
    .input:focus {
      box-shadow: 0 0 0 2px #0ea5e9;
      border-color: #0ea5e9;
    }
    .btn-secondary {
      padding: 0.5rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #cbd5e1;
      font-size: 0.875rem;
      background-color: #fff;
      transition: background-color 0.2s;
    }
    .btn-secondary:hover {
      background-color: #f1f5f9;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      border: 1px solid #cbd5e1;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      cursor: pointer;
      user-select: none;
    }
    .th {
      padding: 0.5rem 0.75rem;
      font-weight: 500;
    }
    td {
      padding: 0.5rem 0.75rem;
      border-top: 1px solid #f1f5f9;
    }
    #map {
      height: 100%;
      min-height: 320px;
    }
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb; color: #222;
  }
  /* Login Page */
  #loginPage {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #2c3e50;
    color: rgb(0, 0, 0);
  }
  #loginPage form {
    background: #34495e;
    padding: 30px 40px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    width: 320px;
  }
  #loginPage h2 {
    margin-bottom: 20px;
    text-align: center;
    color: #e67e22;
  }
  #loginPage input[type="text"],
  #loginPage input[type="password"] {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 15px;
    border: none;
    border-radius: 4px;
  }
  #loginPage button {
    width: 100%;
    background: #e67e22;
    border: none;
    padding: 12px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.3s;
  }
  #loginPage button:hover {
    background: #d35400;
  }
  #loginError {
    color: #ff6b6b;
    margin-bottom: 10px;
    text-align: center;
    display: none;
  }

  /* Hide admin panel by default */
  #adminPanel {
    display: none;
  }

  /* Sidebar and Main content styles */
  .sidebar {
    width: 240px; height: 100vh; position: fixed; top: 0; left: 0;
    background: #2c3e50; color: white; display: flex; flex-direction: column;
  }
  .sidebar h2 {
    margin: 20px; font-size: 1.5rem; font-weight: 700; letter-spacing: 1px;
  }
  .sidebar nav {
    flex-grow: 1;
  }
  .sidebar nav a {
    display: block; padding: 15px 25px; color: white; text-decoration: none;
    border-left: 4px solid transparent; font-weight: 600; cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }
  .sidebar nav a:hover, .sidebar nav a.active {
    background: #34495e; border-left: 4px solid #e67e22;
  }
  .main-content {
    margin-left: 240px; padding: 20px;
  }
  h1 {
    margin-top: 0;
    color: #e67e22;
  }
  .panel {
    display: none;
  }
  .panel.active {
    display: block;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top: 10px;
  }
  th, td {
    border: 1px solid #ccc; padding: 8px 12px; text-align: left;
  }
  th {
    background: #e67e22; color: white;
  }
  input[type="text"], input[type="email"], input[type="date"] {
    padding: 6px; width: 100%; max-width: 300px; margin-bottom: 10px;
    border: 1px solid #ccc; border-radius: 4px;
  }
  button {
    background: #e67e22; color: white; border: none; padding: 10px 16px;
    cursor: pointer; border-radius: 4px;
    font-weight: 600;
  }
  button:hover {
    background: #d35400;
  }
  @media (max-width: 768px) {
    .sidebar {
      width: 100%; height: auto; position: relative; flex-direction: row; overflow-x: auto;
    }
    .sidebar nav a {
      flex: 1 0 auto; border-left: none; border-bottom: 4px solid transparent; text-align: center; padding: 10px;
    }
    .sidebar nav a:hover, .sidebar nav a.active {
      border-left: none; border-bottom: 4px solid #e67e22; background: #34495e;
    }
    .main-content {
      margin-left: 0; padding: 10px;
    }
  }
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
  <form id="loginForm">
    <h2>Login Admin</h2>
    <div id="loginError">Username atau password salah!</div>
    <input type="text" id="username" placeholder="Username" required autocomplete="off" />
    <input type="password" id="password" placeholder="Password" required autocomplete="off" />
    <button type="submit">Login</button>
  </form>
</div>

<!-- Admin Panel -->
<div id="adminPanel">
  <div class="sidebar">
    <h2>Sensus Purbalingga 2025</h2>
    <nav>
      <a href="#" class="active" data-panel="dashboard">Dashboard</a>
      <a href="#" data-panel="responden">Manajemen Responden</a>
      <a href="#" data-panel="wilayah">Informasi</a>
      <a href="#" data-panel="petugas">Manajemen Petugas</a>
      <a href="#" data-panel="laporan">Laporan & Statistik</a>
      <a href="#" data-panel="pengguna">Manajemen Pengguna</a>
      <a href="#" data-panel="pengaturan">Pengaturan</a>
      <a href="#" id="logoutBtn" style="color:#e74c3c; font-weight:700; margin:10px 25px 0; cursor:pointer;">Logout</a>
    </nav>
  </div>

  <div class="main-content">
    <!-- Dashboard -->
    <section id="dashboard" class="panel active">
     </head>
<body class="bg-slate-50 text-slate-800">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-sky-500 to-emerald-500 grid place-items-center text-white font-bold">SP</div>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold">Dashboard Sensus Penduduk <span class="text-sky-700">Purbalingga 2025</span></h1>
          <p class="text-xs text-slate-500">Update: <span id="lastUpdated"></span></p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <input id="searchInput" type="search" placeholder="Cari kecamatan..." class="rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        <select id="statusFilter" class="rounded-xl border border-slate-300 px-3 py-2 text-sm">
          <option value="ALL">Semua Status</option>
          <option value="Sudah">Sudah didata</option>
          <option value="Proses">Dalam proses</option>
          <option value="Belum">Belum didata</option>
        </select>
        <button id="downloadCSV" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Unduh CSV</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- Sidebar -->
    <aside class="lg:col-span-3">
      <div class="card">
        <h2 class="card-title">Filter</h2>
        <div class="space-y-4">
          <div>
            <label class="label">Tempat Lahir</label>
            <div id="tempatLahirList" class="grid grid-cols-2 gap-2 max-h-64 overflow-auto"></div>
          </div>
          <button id="resetFilters" class="w-full btn-secondary mt-4">Reset Filter</button>
        </div>
      </div>
    </aside>

    <!-- Content -->
    <section class="lg:col-span-9 space-y-6">

      <!-- KPI -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="kpi"><div class="kpi-label">Total Penduduk</div><div class="kpi-value" id="kpiPopulation">-</div></div>
        <div class="kpi"><div class="kpi-label">Kepala Keluarga</div><div class="kpi-value" id="kpiHouseholds">-</div></div>
        <div class="kpi"><div class="kpi-label">Progres Sensus</div><div class="kpi-value" id="kpiCompletion">-</div></div>
        <div class="kpi"><div class="kpi-label">Petugas Aktif</div><div class="kpi-value" id="kpiEnumerators">-</div></div>
      </div>

      <!-- Charts -->
      <div class="grid md:grid-cols-2 gap-6">
        <div class="card"><h3 class="card-title">Populasi per Kecamatan</h3><canvas id="barPopulation"></canvas></div>
        <div class="card"><h3 class="card-title">% Penyelesaian</h3><canvas id="pieCompletion"></canvas></div>
      </div>
      <div class="card"><h3 class="card-title">Tren Harian Pendataan</h3><canvas id="lineTrend"></canvas></div>

      <!-- Map + Table -->
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="card h-[420px]"><h3 class="card-title">Peta Kecamatan</h3><div id="map" class="rounded-2xl w-full h-full"></div></div>
        <div class="card">
          <h3 class="card-title">Tabel Ringkas</h3>
          <table class="min-w-full text-sm" id="tableKecamatan">
            <thead><tr class="bg-slate-100 text-left"><th class="th">Kecamatan</th><th class="th">Populasi</th><th class="th">KK</th><th class="th">% Selesai</th><th class="th">Status</th></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
  </main>
    </section>

  <!-- Manajemen Responden -->
<section id="responden" class="panel">
  <h1>Manajemen Responden</h1>
  <input type="text" id="searchResponden" placeholder="Cari nama responden..." />
  <table>
    <thead>
      <tr>
        <th>NIK</th>
        <th>Nama</th>
        <th>Alamat</th>
        <th>Tempat Lahir</th>
        <th>Tanggal Lahir</th>
        <th>Jenis Kelamin</th>
        <th>Pekerjaan</th>
        <th>Status Perkawinan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="respondenTableBody">
      <!-- Contoh data statis -->
      <tr>
        <td>3301234567890001</td>
        <td>Sari Wulandari</td>
        <td>Jl. Diponegoro No.12</td>
        <td>Bukateja</td>
        <td>1995-04-12</td>
        <td>Perempuan</td>
        <td>Guru</td>
        <td>Kawin</td>
        <td><button>Hapus</button></td>
      </tr>
      <tr>
        <td>3301234567890002</td>
        <td>Joko Santoso</td>
        <td>Jl. Jendral Sudirman No.34</td>
        <td>Kalimanah</td>
        <td>1990-09-21</td>
        <td>Laki-laki</td>
        <td>Petani</td>
        <td>Belum Kawin</td>
        <td><button>Hapus</button></td>
      </tr>
    </tbody>
  </table>
</section>



    <!-- Informasi dan Pengumuman -->
    <section id="wilayah" class="panel">
      <title>Informasi & Pengumuman — Sensus Penduduk Purbalingga 2025</title>
<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --accent:#2563eb;
    --accent-2:#0ea5e9;
    --danger:#ef4444;
    --success:#16a34a;
    --warning:#d97706;
    --ring:rgba(37,99,235,.25);
    --chip:#e5e7eb;
    --chip-text:#374151;
    --shadow:0 10px 30px rgba(0,0,0,.06);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,#eef2ff 0%, #f8fafc 100%);
    color:var(--text);
  }

  .wrap{max-width:1100px; margin:0 auto; padding:16px}
  .head{
    display:flex; align-items:center; gap:12px; flex-wrap:wrap; padding:14px 0;
  }
  .logo{
    width:40px;height:40px; border-radius:10px; background:#fff1;
    display:grid; place-items:center; font-weight:700; letter-spacing:.5px;
    box-shadow:inset 0 0 0 2px #fff3;
  }
  .title{font-size:1.2rem; font-weight:700; line-height:1.2}
  .subtitle{font-size:.9rem; opacity:.9}
  .toolbar{
    display:flex; flex-wrap:wrap; gap:10px; margin-top:10px
  }
  .input, .select{
    appearance:none; border:1px solid #e5e7eb; background:#fff; color:var(--text);
    padding:10px 12px; border-radius:12px; min-width:140px;
    outline:none; box-shadow:0 1px 0 #00000005;
  }
  .input:focus, .select:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
  .btn{
    border:none; background:var(--accent); color:#fff; padding:10px 14px; border-radius:12px;
    font-weight:600; cursor:pointer; transition:.2s; box-shadow:var(--shadow);
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.outline{background:#fff; color:var(--accent); border:1px solid var(--accent)}
  .btn.ghost{background:transparent; color:#fff; border:1px solid #ffffff66}
  .btn.danger{background:var(--danger)}
  main{padding:22px 0}
  .grid{
    display:grid; gap:16px;
    grid-template-columns:1.2fr .8fr;
  }
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px;
  }
  .card h3{margin:0 0 12px 0; font-size:1.1rem}
  .hint{color:var(--muted); font-size:.9rem}

  /* chips */
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{
    padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--chip-text);
    font-size:.8rem; display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
  }
  .chip[data-type="darurat"]{background:#fee2e2; color:#991b1b}
  .chip[data-type="penting"]{background:#fff7ed; color:#9a3412}
  .chip[data-type="informasi"]{background:#ecfeff; color:#155e75}
  .chip .dot{width:8px; height:8px; border-radius:50%}
  .dot.darurat{background:#ef4444}
  .dot.penting{background:#f59e0b}
  .dot.informasi{background:#06b6d4}

  /* list */
  .list{display:flex; flex-direction:column; gap:12px}
  .item{
    border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff;
    display:grid; grid-template-columns:1fr auto; gap:8px; align-items:start;
  }
  .item h4{margin:0; font-size:1rem}
  .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:.85rem}
  .actions{display:flex; gap:8px}
  .badge{
    padding:4px 8px; border-radius:8px; font-size:.75rem; font-weight:600;
    background:#e5e7eb; color:#374151;
  }
  .badge.green{background:#dcfce7; color:#166534}
  .badge.gray{background:#f3f4f6; color:#374151}
  .pin{font-size:.9rem; color:#f59e0b}

  /* timeline */
  .timeline{position:relative; margin-left:8px}
  .tl-item{
    position:relative; padding-left:22px; margin:14px 0;
  }
  .tl-item::before{
    content:""; position:absolute; left:6px; top:4px; width:8px; height:8px; border-radius:50%;
    background:var(--accent);
  }
  .tl-item::after{
    content:""; position:absolute; left:9.5px; top:18px; width:2px; height:calc(100% - 18px);
    background:#e5e7eb;
  }

  /* modal */
  dialog{
    border:none; border-radius:18px; padding:0; width:min(720px, 92vw);
    box-shadow:0 30px 80px rgba(0,0,0,.2);
  }
  .modal{
    padding:18px; background:#fff; border-radius:18px;
  }
  .modal .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media (max-width:700px){ .modal .row{grid-template-columns:1fr} }
  label{font-size:.9rem; color:#374151; display:block; margin:4px 0}
  textarea{min-height:110px; resize:vertical}
  textarea,input,select{
    width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:10px; outline:none;
  }
  textarea:focus,input:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
  .modal .footer{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}

  .empty{
    padding:18px; text-align:center; color:var(--muted); border:1px dashed #e5e7eb; border-radius:14px;
  }

  .k-counts{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 6px}
  .k{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; font-size:.85rem}
  .k strong{font-size:1rem}
  .sr-only{position:absolute; left:-9999px}
  a.link{color:var(--accent)}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="head">
        <div class="logo" aria-hidden="true">SP</div>
        <div>
          <div class="title">Informasi & Pengumuman</div>
          <div class="subtitle">Sensus Penduduk Purbalingga 2025</div>
        </div>
        <div style="flex:1"></div>
        <button id="btnPrint" class="btn ghost" title="Cetak/Unduh">Cetak</button>
        <button id="btnNew" class="btn" title="Tambah Pengumuman">+ Pengumuman</button>
      </div>

      <div class="toolbar">
        <input id="q" class="input" placeholder="Cari judul/konten/author… (Ctrl+/)"/>
        <select id="fKategori" class="select">
          <option value="">Semua Kategori</option>
          <option>Sosialisasi</option>
          <option>Teknis Petugas</option>
          <option>Jadwal</option>
          <option>Umum</option>
        </select>
        <select id="fStatus" class="select">
          <option value="">Semua Status</option>
          <option value="published">Dipublikasikan</option>
          <option value="draft">Draft</option>
        </select>
        <select id="fUrgensi" class="select">
          <option value="">Semua Urgensi</option>
          <option value="informasi">Informasi</option>
          <option value="penting">Penting</option>
          <option value="darurat">Darurat</option>
        </select>
        <input id="fDateFrom" class="input" type="date" title="Dari tanggal"/>
        <input id="fDateTo" class="input" type="date" title="Sampai tanggal"/>
        <button id="btnReset" class="btn outline">Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Counts -->
    <div class="k-counts" id="counts"></div>

    <div class="grid">
      <section class="card" aria-labelledby="terbaru">
        <h3 id="terbaru">Terbaru & Tersemat</h3>
        <p class="hint">Item yang dipin akan selalu di atas. Klik judul untuk membuka tautan lampiran (jika ada).</p>
        <div id="latest" class="list"></div>
      </section>

      <aside class="card" aria-labelledby="timeline">
        <h3 id="timeline">Timeline</h3>
        <div id="timelineList" class="timeline"></div>
      </aside>
    </div>

    <section class="card" style="margin-top:16px" aria-labelledby="tabel">
      <h3 id="tabel">Daftar Pengumuman</h3>
      <div id="table" class="list"></div>
    </section>
  </main>

  <!-- Modal Form -->
  <dialog id="dlg">
    <form method="dialog" class="modal" id="form">
      <h3 id="dlgTitle">Tambah Pengumuman</h3>
      <div class="row">
        <div>
          <label for="title">Judul</label>
          <input id="title" required placeholder="Contoh: Jadwal Sosialisasi Kecamatan Kalimanah"/>
        </div>
        <div>
          <label for="author">Author / Unit</label>
          <input id="author" placeholder="Contoh: BPS Purbalingga"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="kategori">Kategori</label>
          <select id="kategori" required>
            <option value="Sosialisasi">Sosialisasi</option>
            <option value="Teknis Petugas">Teknis Petugas</option>
            <option value="Jadwal">Jadwal</option>
            <option value="Umum">Umum</option>
          </select>
        </div>
        <div>
          <label for="urgensi">Urgensi</label>
          <select id="urgensi" required>
            <option value="informasi">Informasi</option>
            <option value="penting">Penting</option>
            <option value="darurat">Darurat</option>
          </select>
        </div>
      </div>

      <div>
        <label for="content">Isi Pengumuman</label>
        <textarea id="content" placeholder="Tulis isi ringkas pengumuman…"></textarea>
      </div>

      <div class="row">
        <div>
          <label for="publishAt">Tanggal Publikasi</label>
          <input id="publishAt" type="datetime-local" required/>
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option value="published">Dipublikasikan</option>
            <option value="draft">Draft</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="audience">Audiens (opsional)</label>
          <input id="audience" placeholder="Petugas, Masyarakat umum, Koordinator…"/>
        </div>
        <div>
          <label for="link">Tautan Lampiran (opsional)</label>
          <input id="link" type="url" placeholder="https://…"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label><input type="checkbox" id="pinned"/> Sematkan di atas</label>
        </div>
        <div>
          <label><input type="checkbox" id="notify"/> Tampilkan notifikasi (UI saja)</label>
        </div>
      </div>

      <div class="footer">
        <button type="submit" class="btn">Simpan</button>
        <button type="button" id="btnCancel" class="btn outline">Batal</button>
      </div>
      <input type="hidden" id="id"/>
    </form>
  </dialog>

<script>
(function(){
  const LS_KEY = 'sensus_announcements_pbg2025';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    items: [],
    filters: { q:'', kategori:'', status:'', urgensi:'', from:'', to:'' }
  };

  // --- Utilities
  const fmtDate = (dStr) => {
    const d = new Date(dStr);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleString('id-ID', { dateStyle:'medium', timeStyle:'short' });
  };
  const todayLocalISO = () => {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,16);
  };

  const save = () => localStorage.setItem(LS_KEY, JSON.stringify(state.items));
  const load = () => {
    const raw = localStorage.getItem(LS_KEY);
    state.items = raw ? JSON.parse(raw) : seed();
    // sort newest first by publishAt
    state.items.sort((a,b)=> new Date(b.publishAt) - new Date(a.publishAt));
  };

  const seed = () => {
    const now = new Date();
    const iso = (offsetHours) => {
      const d = new Date(now.getTime() + offsetHours*3600*1000);
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0,16);
    };
    return [
      {
        id: crypto.randomUUID(),
        title: "Pengumuman Resmi Kickoff Sensus Penduduk 2025",
        content: "Pelaksanaan sensus dimulai 1 September 2025 di seluruh kecamatan Purbalingga. Mohon dukungan aktif masyarakat.",
        author:"BPS Purbalingga",
        kategori:"Umum",
        urgensi:"informasi",
        status:"published",
        audience:"Masyarakat umum",
        link:"",
        publishAt: iso(-240),
        pinned:true,
        notify:true
      },
      {
        id: crypto.randomUUID(),
        title: "Jadwal Briefing Petugas Lapangan Gelombang 1",
        content: "Briefing di Aula Kantor Kecamatan Kalimanah, 27–28 Agustus 2025. Wajib hadir untuk seluruh petugas rayon Kalimanah.",
        author:"Koordinator Lapangan",
        kategori:"Jadwal",
        urgensi:"penting",
        status:"published",
        audience:"Petugas Lapangan",
        link:"",
        publishAt: iso(-120),
        pinned:false,
        notify:false
      },
      {
        id: crypto.randomUUID(),
        title: "Perubahan Form Teknis Validasi NIK",
        content: "Terdapat pembaruan aturan validasi NIK pada aplikasi enumerator versi 1.0.7. Harap unduh panduan terbaru.",
        author:"Tim Teknis",
        kategori:"Teknis Petugas",
        urgensi:"penting",
        status:"published",
        audience:"Petugas & Korlap",
        link:"https://contoh.link/panduan.pdf",
        publishAt: iso(-72),
        pinned:false,
        notify:false
      },
      {
        id: crypto.randomUUID(),
        title: "Peringatan Cuaca Ekstrem Saat Pendataan",
        content: "Potensi hujan lebat di wilayah Bobotsari–Karangreja. Utamakan keselamatan, tunda sementara pendataan di zona merah.",
        author:"Posko Sensus",
        kategori:"Umum",
        urgensi:"darurat",
        status:"published",
        audience:"Seluruh Petugas",
        link:"",
        publishAt: iso(-6),
        pinned:true,
        notify:true
      },
      {
        id: crypto.randomUUID(),
        title: "Materi Sosialisasi untuk Desa Karangpucung",
        content: "Slide sosialisasi dan poster siap diunduh. Mohon koordinasikan dengan perangkat desa.",
        author:"Humas Sensus",
        kategori:"Sosialisasi",
        urgensi:"informasi",
        status:"draft",
        audience:"Tim Humas",
        link:"",
        publishAt: iso(-1),
        pinned:false,
        notify:false
      }
    ];
  };

  // --- Rendering
  const chipUrgensi = (u) => {
    const label = u === 'darurat' ? 'Darurat' : (u==='penting'?'Penting':'Informasi');
    const dot = `<span class="dot ${u}"></span>`;
    return `<span class="chip" data-type="${u}">${dot}${label}</span>`;
  };
  const badgeStatus = (s) => s==='published' ? `<span class="badge green">Dipublikasikan</span>` : `<span class="badge gray">Draft</span>`;
  const chipKategori = (k)=> `<span class="chip">${k}</span>`;
  const chipAudience = (a)=> a?`<span class="chip">${a}</span>`:'';

  function applyFilters(items){
    const {q,kategori,status,urgensi,from,to} = state.filters;
    return items.filter(it=>{
      if (q){
        const h = (it.title+' '+it.content+' '+(it.author||'')).toLowerCase();
        if (!h.includes(q.toLowerCase())) return false;
      }
      if (kategori && it.kategori!==kategori) return false;
      if (status && it.status!==status) return false;
      if (urgensi && it.urgensi!==urgensi) return false;
      if (from && new Date(it.publishAt) < new Date(from)) return false;
      if (to){
        const end = new Date(to); end.setHours(23,59,59,999);
        if (new Date(it.publishAt) > end) return false;
      }
      return true;
    });
  }

  function renderCounts(){
    const all = applyFilters(state.items);
    const total = all.length;
    const published = all.filter(a=>a.status==='published').length;
    const draft = total - published;
    const pinned = all.filter(a=>a.pinned).length;
    const darurat = all.filter(a=>a.urgensi==='darurat').length;
    $('#counts').innerHTML = `
      <div class="k"><div>Total</div><strong>${total}</strong></div>
      <div class="k"><div>Dipublikasikan</div><strong>${published}</strong></div>
      <div class="k"><div>Draft</div><strong>${draft}</strong></div>
      <div class="k"><div>Tersemat</div><strong>${pinned}</strong></div>
      <div class="k"><div>Darurat</div><strong>${darurat}</strong></div>
    `;
  }

  function renderLatest(){
    const list = applyFilters(state.items)
      .sort((a,b)=>{
        if (a.pinned!==b.pinned) return (b.pinned?1:0) - (a.pinned?1:0);
        return new Date(b.publishAt) - new Date(a.publishAt);
      })
      .slice(0,8);

    const html = list.map(it=> `
      <article class="item" data-id="${it.id}">
        <div>
          <h4 title="${it.title}">
            ${it.pinned?`<span class="pin" title="Tersemat">📌</span>`:''}
            ${it.link?`<a class="link" href="${it.link}" target="_blank" rel="noopener">${it.title}</a>`: it.title}
          </h4>
          <div class="meta">
            ${chipUrgensi(it.urgensi)}
            ${chipKategori(it.kategori)}
            ${chipAudience(it.audience)}
            <span>•</span>
            <span>${fmtDate(it.publishAt)}</span>
            <span>•</span>
            <span>Oleh ${it.author||'Panitia'}</span>
            ${badgeStatus(it.status)}
          </div>
          <p style="margin:.5rem 0 0; color:#111827">${it.content}</p>
        </div>
        <div class="actions">
          <button class="btn outline" data-action="edit">Edit</button>
          <button class="btn outline" data-action="pin">${it.pinned?'Lepas Pin':'Pin'}</button>
          <button class="btn outline" data-action="toggle">${it.status==='published'?'Jadikan Draft':'Publikasikan'}</button>
          <button class="btn danger" data-action="del">Hapus</button>
        </div>
      </article>
    `).join('');
    $('#latest').innerHTML = html || `<div class="empty">Belum ada pengumuman untuk filter saat ini.</div>`;
  }

  function renderTimeline(){
    const list = applyFilters(state.items)
      .slice().sort((a,b)=> new Date(b.publishAt) - new Date(a.publishAt));
    const html = list.map(it=> `
      <div class="tl-item">
        <div class="chips" style="margin-bottom:6px">
          ${chipUrgensi(it.urgensi)} ${chipKategori(it.kategori)} ${badgeStatus(it.status)}
        </div>
        <div style="font-weight:600">${it.title}</div>
        <div class="hint">${fmtDate(it.publishAt)} • ${it.author||'Panitia'}</div>
      </div>
    `).join('');
    $('#timelineList').innerHTML = html || `<div class="empty">Kosong.</div>`;
  }

  function renderTable(){
    const list = applyFilters(state.items);
    const html = list.map(it=> `
      <article class="item" data-id="${it.id}">
        <div>
          <h4>${it.title}</h4>
          <div class="meta">
            ${chipUrgensi(it.urgensi)} ${chipKategori(it.kategori)} ${chipAudience(it.audience)}
            <span>•</span><span>${fmtDate(it.publishAt)}</span>
            <span>•</span><span>${it.author||'Panitia'}</span>
          </div>
          <p style="margin:.5rem 0; color:#111827">${it.content}</p>
          ${it.link?`<a class="link" href="${it.link}" target="_blank" rel="noopener">Buka Lampiran ↗</a>`:''}
        </div>
        <div class="actions">
          <button class="btn outline" data-action="edit">Edit</button>
          <button class="btn outline" data-action="pin">${it.pinned?'Lepas Pin':'Pin'}</button>
          <button class="btn outline" data-action="toggle">${it.status==='published'?'Jadikan Draft':'Publikasikan'}</button>
          <button class="btn danger" data-action="del">Hapus</button>
        </div>
      </article>
    `).join('');
    $('#table').innerHTML = html || `<div class="empty">Tidak ada data.</div>`;
  }

  function renderAll(){
    renderCounts();
    renderLatest();
    renderTimeline();
    renderTable();
  }

  // --- Actions
  function openForm(item){
    $('#dlgTitle').textContent = item? 'Edit Pengumuman' : 'Tambah Pengumuman';
    $('#id').value = item?.id || '';
    $('#title').value = item?.title || '';
    $('#author').value = item?.author || '';
    $('#kategori').value = item?.kategori || 'Umum';
    $('#urgensi').value = item?.urgensi || 'informasi';
    $('#content').value = item?.content || '';
    $('#publishAt').value = item?.publishAt || todayLocalISO();
    $('#status').value = item?.status || 'published';
    $('#audience').value = item?.audience || '';
    $('#link').value = item?.link || '';
    $('#pinned').checked = !!item?.pinned;
    $('#notify').checked = !!item?.notify;
    $('#dlg').showModal();
    setTimeout(()=>$('#title').focus(), 30);
  }

  function readForm(){
    return {
      id: $('#id').value || crypto.randomUUID(),
      title: $('#title').value.trim(),
      author: $('#author').value.trim(),
      kategori: $('#kategori').value,
      urgensi: $('#urgensi').value,
      content: $('#content').value.trim(),
      publishAt: $('#publishAt').value,
      status: $('#status').value,
      audience: $('#audience').value.trim(),
      link: $('#link').value.trim(),
      pinned: $('#pinned').checked,
      notify: $('#notify').checked
    };
  }

  function upsert(item){
    const i = state.items.findIndex(x=>x.id===item.id);
    if (i>=0) state.items[i]=item; else state.items.unshift(item);
    save(); renderAll();
    if (item.notify && item.status==='published'){
      // Simple toast
      const toast = document.createElement('div');
      toast.textContent = '🔔 Pengumuman baru: ' + item.title;
      Object.assign(toast.style,{
        position:'fixed', right:'16px', bottom:'16px', background:'#111827', color:'#fff',
        padding:'12px 14px', borderRadius:'12px', boxShadow:'var(--shadow)', zIndex:9999
      });
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 4000);
    }
  }

  function del(id){
    if(!confirm('Hapus pengumuman ini?')) return;
    state.items = state.items.filter(x=>x.id!==id);
    save(); renderAll();
  }

  function togglePin(id){
    const it = state.items.find(x=>x.id===id); if(!it) return;
    it.pinned = !it.pinned; save(); renderAll();
  }
  function toggleStatus(id){
    const it = state.items.find(x=>x.id===id); if(!it) return;
    it.status = it.status==='published'?'draft':'published'; save(); renderAll();
  }

  // --- Events
  $('#btnNew').addEventListener('click', ()=>openForm());
  $('#btnCancel').addEventListener('click', ()=>$('#dlg').close());
  $('#form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const item = readForm();
    if (!item.title) return alert('Judul wajib diisi.');
    if (!item.publishAt) return alert('Tanggal publikasi wajib diisi.');
    upsert(item);
    $('#dlg').close();
  });

  // Delegate actions
  ['latest','table'].forEach(id=>{
    $('#'+id).addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const wrap = e.target.closest('.item'); if(!wrap) return;
      const id = wrap.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (action==='edit') openForm(state.items.find(x=>x.id===id));
      if (action==='del') del(id);
      if (action==='pin') togglePin(id);
      if (action==='toggle') toggleStatus(id);
    });
  });

  // Filters
  const applyAndRender = ()=>{
    state.filters.q = $('#q').value.trim();
    state.filters.kategori = $('#fKategori').value;
    state.filters.status = $('#fStatus').value;
    state.filters.urgensi = $('#fUrgensi').value;
    state.filters.from = $('#fDateFrom').value;
    state.filters.to = $('#fDateTo').value;
    renderAll();
  };
  $$('#fKategori,#fStatus,#fUrgensi,#fDateFrom,#fDateTo').forEach(el=> el.addEventListener('change', applyAndRender));

  let t;
  $('#q').addEventListener('input', ()=>{
    clearTimeout(t); t=setTimeout(applyAndRender, 200);
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key==='/' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); $('#q').focus(); }
  });
  $('#btnReset').addEventListener('click', ()=>{
    $('#q').value=''; $('#fKategori').value=''; $('#fStatus').value=''; $('#fUrgensi').value='';
    $('#fDateFrom').value=''; $('#fDateTo').value='';
    applyAndRender();
  });

  // Print
  $('#btnPrint').addEventListener('click', ()=> window.print());

  // Init
  load(); renderAll();

})();
</script>
    </section>

    <!-- Manajemen Petugas -->
    <section id="petugas" class="panel">
      <h1>Manajemen Petugas Lapangan</h1>
      <table>
        <thead>
          <tr>
            <th>Nama Petugas</th>
            <th>Kecamatan Tugas</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Ani Susanti</td><td>Bukateja</td><td>Aktif</td></tr>
          <tr><td>Budi Hartono</td><td>Kalimanah</td><td>Aktif</td></tr>
          <tr><td>Charlie Wijaya</td><td>Karangmoncol</td><td>Nonaktif</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Laporan & Statistik -->
    <section id="laporan" class="panel">
      <h1>Laporan & Statistik</h1>
      <p>Ekspor data dan laporan hasil sensus Kabupaten Purbalingga.</p>
      <a href="404 page.html" onclick="alert('Fitur export PDF belum tersedia')"><button>Export PDF</button></a>
      <a href="404 page.html" onclick="alert('Fitur export Excel belum tersedia')"><button>Export Excel</button></a>
    </section>

    <!-- Manajemen Pengguna -->
    <section id="pengguna" class="panel">
      <h1>Manajemen Pengguna</h1>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Role</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>adminpbg</td><td>Administrator</td><td>Aktif</td></tr>
          <tr><td>petugasbukateja</td><td>Petugas Lapangan</td><td>Aktif</td></tr>
          <tr><td>petugaskalimanah</td><td>Petugas Lapangan</td><td>Nonaktif</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Pengaturan -->
    <section id="pengaturan" class="panel">
  <title>Pengaturan Sensus 2025</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: 25px auto;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 18px;
    }
    .card {
      background: #fff;
      border-radius: 15px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .icon {
      width: 50px; height: 50px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; color: #fff;
      margin: 0 auto 12px;
    }
    .blue { background: #0d6efd; }
    .green { background: #28a745; }
    .orange { background: #fd7e14; }
    .purple { background: #6f42c1; }
    label {
      font-weight: bold; display: block;
      margin-bottom: 6px; font-size: 14px;
    }
    select, input[type="date"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
      width: 100%;
      background: #f9f9f9;
      text-align: center;
    }
    .toggle {
      display: flex; justify-content: center; align-items: center;
      gap: 6px; font-size: 13px;
    }
    .toggle input { transform: scale(1.2); }
    .actions {
      text-align: center;
      margin-top: 20px;
    }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      transition: 0.3s;
    }
    .save { background: #0d6efd; color: #fff; }
    .save:hover { background: #0b5ed7; }
    .reset { background: #dc3545; color: #fff; }
    .reset:hover { background: #b02a37; }
    footer {
      background: #0d6efd; color: #fff;
      text-align: center; padding: 12px;
      margin-top: 30px; font-size: 13px;
    }
  </style>
</head>
<body>
  <header>Pengaturan Sensus Penduduk 2025</header>

  <div class="container">
    <div class="card">
      <div class="icon blue">📋</div>
      <label>Status Pendaftaran</label>
      <select id="status">
        <option>🟢 Dibuka</option>
        <option>🔴 Ditutup</option>
        <option>⏸️ Ditunda</option>
      </select>
    </div>

    <div class="card">
      <div class="icon green">📅</div>
      <label>Jadwal Sensus</label>
      <input type="date" id="schedule">
    </div>

    <div class="card">
      <div class="icon orange">🔔</div>
      <label>Notifikasi</label>
      <div class="toggle">
        <input type="checkbox" id="notif" checked> Aktif
      </div>
    </div>

    <div class="card">
      <div class="icon purple">💾</div>
      <label>Backup Data</label>
      <select id="backup">
        <option>Harian</option>
        <option>Mingguan</option>
        <option>Bulanan</option>
        <option>Tidak Ada</option>
      </select>
    </div>
  </div>

  <div class="actions">
    <button class="save" onclick="saveSettings()">💾 Simpan</button>
    <button class="reset" onclick="resetData()">🗑️ Reset</button>
  </div>


  <script>
    function saveSettings() {
      const status = document.getElementById("status").value;
      const schedule = document.getElementById("schedule").value;
      const notif = document.getElementById("notif").checked;
      const backup = document.getElementById("backup").value;
      alert(`✅ Pengaturan Disimpan:\nStatus: ${status}\nJadwal: ${schedule}\nNotifikasi: ${notif}\nBackup: ${backup}`);
    }
    function resetData() {
      if(confirm("⚠️ Yakin reset semua data?")) {
        alert("🗑️ Semua data berhasil direset!");
      }
    }
  </script>
</div>

<script>
const validUser = {username:"adminpbg", password:"purbalingga2025"};
const loginPage=document.getElementById("loginPage"), adminPanel=document.getElementById("adminPanel"), loginForm=document.getElementById("loginForm"), loginError=document.getElementById("loginError");
function checkLogin(){
  if(sessionStorage.getItem("loggedIn")==="true"){loginPage.style.display="none"; adminPanel.style.display="block"; loadRespondenTable();}
  else{loginPage.style.display="flex"; adminPanel.style.display="none";}
}
loginForm.addEventListener("submit",e=>{
  e.preventDefault();
  const u=loginForm.username.value.trim(), p=loginForm.password.value.trim();
  if(u===validUser.username && p===validUser.password){sessionStorage.setItem("loggedIn","true"); loginError.style.display="none"; loginForm.reset(); checkLogin();}
  else{loginError.style.display="block";}
});
document.getElementById("logoutBtn").addEventListener("click",()=>{sessionStorage.removeItem("loggedIn"); checkLogin();});
const navLinks=document.querySelectorAll(".sidebar nav a[data-panel]"), panels=document.querySelectorAll(".panel");
navLinks.forEach(link=>{link.addEventListener("click",e=>{e.preventDefault(); navLinks.forEach(l=>l.classList.remove("active")); panels.forEach(p=>p.classList.remove("active")); link.classList.add("active"); document.getElementById(link.getAttribute("data-panel")).classList.add("active");});});
// Load data sensus dari localStorage ke tabel responden
function loadRespondenTable() {
  const tbody = document.getElementById('respondenTableBody');
  tbody.innerHTML = "";

  const dataSensus = JSON.parse(localStorage.getItem('dataSensus')) || [];

  dataSensus.forEach((data, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${data.nik}</td>
      <td>${data.nama}</td>
      <td>${data.alamat}</td>
      <td>${data.tempatLahir}</td>
      <td>${data.tanggalLahir || "-"}</td>
      <td>${data.jenisKelamin}</td>
      <td>${data.pekerjaan || "-"}</td>
      <td>${data.statusPerkawinan || "-"}</td>
      <td><button onclick="hapusResponden(${index})">Hapus</button></td>
    `;
    tbody.appendChild(tr);
  });
}


// Fungsi hapus responden
function hapusResponden(index) {
  let dataSensus = JSON.parse(localStorage.getItem('dataSensus')) || [];
  if (confirm(`Apakah yakin ingin menghapus data NIK ${dataSensus[index].nik}?`)) {
    dataSensus.splice(index, 1); // hapus 1 data
    localStorage.setItem('dataSensus', JSON.stringify(dataSensus));
    loadRespondenTable(); // refresh tabel
  }
}
checkLogin();

const kecamatanData = [
  { name:"Purbalingga",population:73500,households:18375,completion:92,status:"Sudah",lat:-7.3886,lng:109.3631 },
  { name:"Kalimanah",population:68200,households:17050,completion:88,status:"Proses",lat:-7.3948,lng:109.3217 },
  { name:"Kaligondang",population:59800,households:14950,completion:85,status:"Proses",lat:-7.4179,lng:109.38 },
  { name:"Padamara",population:45500,households:11375,completion:79,status:"Proses",lat:-7.3697,lng:109.3013 },
  { name:"Kejobong",population:40200,households:10050,completion:73,status:"Proses",lat:-7.4332,lng:109.4508 },
  { name:"Kemangkon",population:52000,households:13000,completion:81,status:"Proses",lat:-7.529,lng:109.3539 },
  { name:"Karangjambu",population:22800,households:5700,completion:55,status:"Belum",lat:-7.245,lng:109.2843 },
  { name:"Karangmoncol",population:31800,households:7950,completion:58,status:"Belum",lat:-7.2813,lng:109.3796 }
];
const el = id => document.getElementById(id);
const fmt = new Intl.NumberFormat("id-ID");

function updateKPIs(data){
  el("kpiPopulation").textContent = fmt.format(data.reduce((s,d)=>s+d.population,0));
  el("kpiHouseholds").textContent = fmt.format(data.reduce((s,d)=>s+d.households,0));
  el("kpiCompletion").textContent = (data.reduce((s,d)=>s+d.completion,0)/data.length).toFixed(1)+"%";
  el("kpiEnumerators").textContent = fmt.format(120+Math.floor(Math.random()*40));
}
function renderTable(data){
  el("tableBody").innerHTML = data.map(d=>`<tr><td>${d.name}</td><td>${fmt.format(d.population)}</td><td>${fmt.format(d.households)}</td><td>${d.completion}</td><td>${d.status}</td></tr>`).join("");
}
function renderBar(data){
  new Chart(el("barPopulation"),{type:"bar",data:{labels:data.map(d=>d.name),datasets:[{label:"Populasi",data:data.map(d=>d.population)}]}});
}
function renderPie(data){
  const counts={Sudah:data.filter(d=>d.status==="Sudah").length,Proses:data.filter(d=>d.status==="Proses").length,Belum:data.filter(d=>d.status==="Belum").length};
  new Chart(el("pieCompletion"),{type:"pie",data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts)}]}});
}
function renderLine(){
  const days=[...Array(30)].map((_,i)=>{const d=new Date();d.setDate(d.getDate()-i);return d.toISOString().slice(5,10)}).reverse();
  const vals=days.map(()=>Math.floor(500+Math.random()*500));
  new Chart(el("lineTrend"),{type:"line",data:{labels:days,datasets:[{label:"KK disensus",data:vals,tension:.3}]}});  
}
function renderMap(data){
  const map=L.map("map").setView([-7.39,109.36],10);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  data.forEach(d=>L.circleMarker([d.lat,d.lng],{radius:8}).bindPopup(`${d.name}<br>Pop: ${fmt.format(d.population)}`).addTo(map));
}

document.addEventListener("DOMContentLoaded",()=>{
  el("lastUpdated").textContent=new Date().toLocaleString("id-ID");
  updateKPIs(kecamatanData); renderTable(kecamatanData); renderBar(kecamatanData); renderPie(kecamatanData); renderLine(); renderMap(kecamatanData);
  // Filter kecamatan
  kecamatanData.forEach(d=>{el("kecamatanList").innerHTML+=`<label class="chip"><input type="checkbox" value="${d.name}" checked> ${d.name}</label>`});
  el("resetFilters").onclick=()=>document.querySelectorAll("#kecamatanList input").forEach(cb=>cb.checked=true);
});
</script>

</body>
</html>
